description "Consul"

start on filesystem or runlevel [2345]
stop on runlevel [!2345]

env HOME=/home/{{ run_user }}
setuid {{ run_user }}
setgid docker

respawn
respawn limit 3 30

pre-start script
    /usr/bin/docker rm -f consul || true
end script

pre-stop script
    /usr/bin/docker rm -f consul || true
end script

script
    export HOSTNAME=n2
    docker run --name consul -h $HOSTNAME   \
        -p {{ n2_ip }}:8300:8300   \
        -p {{ n2_ip }}:8301:8301   \
        -p {{ n2_ip }}:8301:8301/udp   \
        -p {{ n2_ip }}:8302:8302   \
        -p {{ n2_ip }}:8302:8302/udp   \
        -p {{ n2_ip }}:8400:8400   \
        -p {{ n2_ip }}:8500:8500   \
        -p {{ docker_ip }}:53:8600   \
        -p {{ docker_ip }}:53:8600/udp   \
        --name consul \
        wehkamp/consul:0.5.2 -server \
            -advertise {{ n2_ip }} \
            -ui-dir /ui \
            -join {{ n1_ip }}
            -log-level debug
end script


